#!/bin/bash

# SuperDeploy - Unified Deployment System
# Version: 1.0.0

# Configuration
SUPERDEPLOY_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BUILD_LIST="${SUPERDEPLOY_HOME}/build.lst"
PROJECTS_DIR="/Users/ryan/development"
LOG_DIR="${SUPERDEPLOY_HOME}/logs"
LOG_FILE="${LOG_DIR}/superdeploy_$(date +%Y%m%d).log"

# Ensure required directories exist
mkdir -p "${LOG_DIR}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging function
log() {
    local level=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "[${timestamp}] [${level}] ${message}" | tee -a "${LOG_FILE}"
}

# Check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check requirements
check_requirements() {
    local missing=()
    
    for cmd in terraform ansible jq; do
        if ! command_exists "$cmd"; then
            missing+=("$cmd")
        fi
    done

    if [ ${#missing[@]} -ne 0 ]; then
        log "ERROR" "Missing required commands: ${missing[*]}"
        exit 1
    fi
}

# Load project list
load_projects() {
    if [ ! -f "${BUILD_LIST}" ]; then
        touch "${BUILD_LIST}"
    fi
    PROJECTS=()
    while IFS= read -r line; do
        if [ -n "$line" ]; then
            # Extract project name from "projectname is a project" format
            project_name=$(echo "$line" | sed 's/ is a project$//')
            [ -n "$project_name" ] && PROJECTS+=("$project_name")
        fi
    done < "${BUILD_LIST}"
}

# List all projects
list_projects() {
    load_projects
    if [ ${#PROJECTS[@]} -eq 0 ]; then
        log "INFO" "No projects found in build list."
    else
        log "INFO" "Managed Projects:"
        for project in "${PROJECTS[@]}"; do
            echo "  - ${project}"
        done
    fi
}

# Check if project exists in build list
project_exists() {
    local project=$1
    load_projects
    for p in "${PROJECTS[@]}"; do
        if [ "$p" == "$project" ]; then
            return 0
        fi
    done
    return 1
}

# Add a new project
add_project() {
    local project=$1

    if project_exists "$project"; then
        log "WARN" "Project '${project}' is already in the build list."
        return 0
    fi

    echo "${project} is a project" >> "${BUILD_LIST}"
    log "INFO" "Added project '${project}' to build list."
}

# Remove a project
remove_project() {
    local project=$1
    
    if ! project_exists "$project"; then
        log "ERROR" "Project '${project}' not found in build list."
        return 1
    fi
    
    # Create a temporary file without the project
    grep -v "^${project} is a project$" "${BUILD_LIST}" > "${BUILD_LIST}.tmp"
    mv "${BUILD_LIST}.tmp" "${BUILD_LIST}"
    
    log "INFO" "Removed project '${project}' from build list."
}

# Deploy a project
deploy_project() {
    local project=$1
    local project_dir="${PROJECTS_DIR}/${project}"
    
    if ! project_exists "$project"; then
        log "ERROR" "Project '${project}' not found in build list."
        return 1
    fi
    
    log "INFO" "Starting deployment for project: ${project}"
    
    # Check if project directory exists
    if [ ! -d "${project_dir}" ]; then
        log "ERROR" "Project directory not found: ${project_dir}"
        return 1
    fi
    
    # Run Terraform
    if [ -d "${project_dir}/terraform" ]; then
        log "INFO" "Running Terraform..."
        (cd "${project_dir}/terraform" && \
         terraform init && \
         terraform apply -auto-approve) || {
            log "ERROR" "Terraform deployment failed for ${project}"
            return 1
        }
    fi
    
    # Run Ansible
    if [ -d "${project_dir}/ansible" ]; then
        log "INFO" "Running Ansible..."
        (cd "${project_dir}/ansible" && {
            # Try different playbook configurations
            if [ -f "deploy.yml" ] && [ -f "inventory.yml" ]; then
                ansible-playbook -i inventory.yml deploy.yml
            elif [ -f "playbook.yml" ] && [ -f "inventory.yml" ]; then
                ansible-playbook -i inventory.yml playbook.yml
            elif [ -f "site.yml" ] && [ -d "inventory" ]; then
                ansible-playbook -i inventory/production site.yml
            else
                log "ERROR" "No suitable ansible configuration found for ${project}"
                return 1
            fi
        }) || {
            log "ERROR" "Ansible deployment failed for ${project}"
            return 1
        }
    fi
    
    log "INFO" "Successfully deployed project: ${project}"
}

# Teardown a project
teardown_project() {
    local project=$1
    local project_dir="${PROJECTS_DIR}/${project}"
    
    if ! project_exists "$project"; then
        log "ERROR" "Project '${project}' not found in build list."
        return 1
    fi
    
    log "WARN" "This will destroy all resources for project: ${project}"
    read -p "Are you sure you want to continue? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log "INFO" "Teardown cancelled."
        return 0
    fi
    
    # Run Terraform destroy
    if [ -d "${project_dir}/terraform" ]; then
        log "INFO" "Destroying Terraform resources..."
        (cd "${project_dir}/terraform" && \
         terraform destroy -auto-approve) || {
            log "ERROR" "Terraform teardown failed for ${project}"
            return 1
        }
    fi
    
    log "INFO" "Successfully tore down project: ${project}"
}

# Check project status
check_project() {
    local project=$1
    local project_dir="${PROJECTS_DIR}/${project}"
    
    if ! project_exists "$project"; then
        log "ERROR" "Project '${project}' not found in build list."
        return 1
    fi
    
    log "INFO" "Checking status for project: ${project}"
    
    # Check Terraform status
    if [ -d "${project_dir}/terraform" ]; then
        log "INFO" "Terraform status:"
        (cd "${project_dir}/terraform" && terraform show)
    fi
    
    log "INFO" "Status check complete for project: ${project}"
}

# Refresh a project
refresh_project() {
    local project=$1
    
    log "INFO" "Refreshing project: ${project}"
    
    # First teardown
    teardown_project "$project" || {
        log "ERROR" "Failed to teardown project during refresh: ${project}"
        return 1
    }
    
    # Then deploy
    deploy_project "$project" || {
        log "ERROR" "Failed to deploy project during refresh: ${project}"
        return 1
    }
    
    log "INFO" "Successfully refreshed project: ${project}"
}

# Main function
main() {
    # Check requirements
    check_requirements
    
    # Parse command line arguments
    local command=$1
    local project=$2
    
    case $command in
        list)
            list_projects
            ;;
        add)
            if [ -z "$project" ]; then
                log "ERROR" "No project specified. Usage: $0 add <project-name>"
                exit 1
            fi
            add_project "$project"
            ;;
        remove)
            if [ -z "$project" ]; then
                log "ERROR" "No project specified. Usage: $0 remove <project-name>"
                exit 1
            fi
            remove_project "$project"
            ;;
        deploy)
            if [ -z "$project" ]; then
                log "ERROR" "No project specified. Usage: $0 deploy <project-name>"
                exit 1
            fi
            deploy_project "$project"
            ;;
        teardown)
            if [ -z "$project" ]; then
                log "ERROR" "No project specified. Usage: $0 teardown <project-name>"
                exit 1
            fi
            teardown_project "$project"
            ;;
        check)
            if [ -z "$project" ]; then
                log "ERROR" "No project specified. Usage: $0 check <project-name>"
                exit 1
            fi
            check_project "$project"
            ;;
        refresh)
            if [ -z "$project" ]; then
                log "ERROR" "No project specified. Usage: $0 refresh <project-name>"
                exit 1
            fi
            refresh_project "$project"
            ;;
        *|help|--help|-h)
            echo "SuperDeploy - Unified Deployment System"
            echo "Usage: $0 <command> [project]"
            echo ""
            echo "Commands:"
            echo "  list                        List all managed projects"
            echo "  add <project>               Add a new project"
            echo "  remove <project>            Remove a project"
            echo "  deploy <project>            Deploy a project"
            echo "  teardown <project>          Tear down a project"
            echo "  check <project>             Check project status"
            echo "  refresh <project>           Rebuild/redeploy a project"
            echo "  help                        Show this help message"
            ;;
    esac
}

# Run main function with all arguments
main "$@"
